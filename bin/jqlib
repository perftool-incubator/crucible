#!/bin/bash
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4 -*-
# vim: autoindent tabstop=4 shiftwidth=4 expandtab softtabstop=4 filetype=bash

function jq_update() {
    local FILE TMP_FILE REASON
    FILE=${1}; shift
    REASON=${2}; shift

    TMP_FILE=${FILE}.tmp

    jq --indent 4 $@ ${FILE} > ${TMP_FILE}
    RC=$?

    if [ ${RC} -ne 0 ]; then
        exit_error "Failed to update ${REASON} in ${FILE}"
    fi

    mv ${TMP_FILE} ${FILE}
}

function jq_query() {
    local FILE QUERY
    FILE=${1}
    QUERY=${2}

    jq -r ${QUERY} ${FILE}
}

function update_repos_config() {
    local REPO BRANCH PATH MODE
    local current_repo_location primary_branch
    local update_mode update_target
    REPO=${1}
    BRANCH=${2}
    PATH=${3}

    REPO_FILE=${PATH}/config/repos.json

    current_repo_location=$(jq_query ${REPO_FILE} '.official[] | select(.name == "crucible") | .repository')
    if [ "${REPO}" != "${current_repo_location}" ]; then
        jq_update ${REPO_FILE} repository --arg repository "${REPO}" '.official[] | select(.name == "crucible") |= (.repository = $repository)'
    fi

    primary_branch=$(jq_query ${REPO_FILE} '.official[] | select(.name == "crucible") | ."primary-branch"')
    checkout_target=$(jq_query ${REPO_FILE} '.official[] | select(.name == "crucible") | .checkout.target')
    checkout_mode=$(jq_query ${REPO_FILE} '.official[] | select(.name == "crucible") | .checkout.mode')
    update_mode=0
    update_target=0
    if [ "${BRANCH}" == "${primary_branch}" ]; then
        if [ "${BRANCH}" == "${checkout_target}" ]; then
            # don't make any changes
        else
            update_target=1

            # what do we do about the mode?
        fi
    else
        if [ "${BRANCH}" == "${checkout_target}" ]; then
            # no need to update the target, but what about the mode?
        else
            update_target=1

            # what do we do about the mode?
        fi
    fi
    if [ ${update_mode} -eq 1 ]; then
        jq_update ${REPO_FILE} checkout.target --arg checkout_mode $MODE '.official[] | select(.name == "crucible") |= (.checkout.mode = $checkout_mode)'
    fi
    if [ ${update_target} -eq 1 ]; then
        jq_update ${REPO_FILE} checkout.target --arg checkout_target $BRANCH '.official[] | select(.name == "crucible") |= (.checkout.target = $checkout_target)'
    fi
}
