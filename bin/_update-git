#!/usr/bin/env bash
# -*- mode: sh; indent-tabs-mode: nil; sh-basic-offset: 4 -*-
# vim: autoindent tabstop=4 shiftwidth=4 expandtab softtabstop=4 filetype=bash

# update a git repository from the current working directory

if [ -d "./.git" ]; then
    # pull updates from remote(s)
    if ! git remote update; then
	exit 1
    fi

    # store any local changes
    stash_output=$(git stash)
    rc=$?
    if [ ${rc} != 0 ]; then
	exit 1
    fi
    echo -e ${stash_output}

    # merge any changes from the remote branch
    if ! git pull --verbose --ff-only; then
	exit 1
    fi

    if ! echo "${stash_output}" | grep -q "No local changes to save"; then
        # reapply local changes
        if ! git stash pop; then
	    exit 1
	fi
    fi
fi

exit 0
